{namespace player}

{template page}
   {param fn}
   {log @fn}
<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8"/>
      <title>Player</title>
      <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
   </head>
   <body>

      {if count(songs)}
         <h2>Here are your songs</h2>
         {render songs songs}
            {param fn @fn}
         {/render}

         <h3 id="CurrentSongLabel">Currently Playing: <span></span></h3>
         <audio controls></audio>

         <script>
         !function()\{
            var $audioPlayer = $("audio");
            var audioPlayer = $audioPlayer[0];
            var $songMenu = $(".song.menu");
            var $li;
            var $label = $("\#CurrentSongLabel span");

            $songMenu.on("click", "li", function()\{
               $li = $(this);
               if(!audioPlayer.paused)\{
                  audioPlayer.pause();
               }
               playTrack(this.innerHTML);
            });
            $audioPlayer.on(\'ended\', function()\{
               if(!$li.next().length)\{
                  $li = $songMenu.children(\':first\');
               } else \{
                  $li = $li.next();
               }
               if($li.length)\{
                  playTrack($li.text());
               }
            });
            function playTrack(track)\{
               $label.text(track);
               audioPlayer.src="songs/"+track;
               audioPlayer.play();
            }
         }();
         </script>
      {:else}
         <h2>You don\'t have any songs.</h2>
         <p>Place some mp3 files in your songs directory to activate the player, then refresh this page.</p>
      {/if}
   </body>
</html>
{/template}

{template songs}
   {param fn}
   <ul class="song menu">
   {foreach .}
      {sort . |asc}
      <li>{@fn.cleanURL(.)}</li>
   {/foreach}
   </ul>
{/template}
